# ÔøΩÔøΩ LLaMA Telegram Bot (v2)

–ü—Ä–æ—Å—Ç–æ–π –∏ –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω—ã–π Telegram –±–æ—Ç –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ª–æ–∫–∞–ª—å–Ω—ã–º–∏ LLaMA –º–æ–¥–µ–ª—è–º–∏ —á–µ—Ä–µ–∑ llama-cpp-python —Å–µ—Ä–≤–µ—Ä. –í–µ—Ä—Å–∏—è 2, —Å –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π –ø—Ä–æ–µ–∫—Ç–∞.

## ‚ú® –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

- üí¨ **–î–∏–∞–ª–æ–≥ —Å LLaMA –º–æ–¥–µ–ª—å—é**
- üß† **–ö–æ–Ω—Ç–µ–∫—Å—Ç –¥–∏–∞–ª–æ–≥–∞** (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 20 —Å–æ–æ–±—â–µ–Ω–∏–π)
- üîÑ **–°–±—Ä–æ—Å –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞** —á–µ—Ä–µ–∑ –∫–æ–º–∞–Ω–¥—É `/start` –∏ inline-–∫–Ω–æ–ø–∫—É
- üöÄ **–ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞** –Ω–∞ `aiogram 3.x`
- üõ°Ô∏è **–ù–∞–¥–µ–∂–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫**
- üìÅ **–ü—Ä–∞–≤–∏–ª—å–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞** —Å `src/`

## üöÄ –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

### 1. –£—Å—Ç–∞–Ω–æ–≤–∫–∞

```bash
# –ö–ª–æ–Ω–∏—Ä—É–µ–º —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
git clone <your-repo-url>
cd LocalAiChat

# –°–æ–∑–¥–∞–µ–º –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ –∏ –∞–∫—Ç–∏–≤–∏—Ä—É–µ–º –µ–≥–æ
python3 -m venv venv
source venv/bin/activate 

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
pip install -r requirements.txt
```

### 2. –ù–∞—Å—Ç—Ä–æ–π–∫–∞

1.  –ü–æ–ª—É—á–∏—Ç–µ —Ç–æ–∫–µ–Ω –±–æ—Ç–∞ —É [@BotFather](https://t.me/BotFather) –≤ Telegram.
2.  –û—Ç–∫—Ä–æ–π—Ç–µ `config_example.py` –∏ –≤—Å—Ç–∞–≤—å—Ç–µ –≤–∞—à —Ç–æ–∫–µ–Ω –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é `BOT_TOKEN`.

### 3. –ó–∞–ø—É—Å–∫ LLaMA —Å–µ—Ä–≤–µ—Ä–∞

–í–∞–º –Ω—É–∂–µ–Ω –∑–∞–ø—É—â–µ–Ω–Ω—ã–π —Å–µ—Ä–≤–µ—Ä `llama-cpp-python`.
[–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –ø–æ —É—Å—Ç–∞–Ω–æ–≤–∫–µ](https://github.com/abetlen/llama-cpp-python?tab=readme-ov-file#web-server)

**–ü—Ä–∏–º–µ—Ä –∫–æ–º–∞–Ω–¥—ã –¥–ª—è –∑–∞–ø—É—Å–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞:**
```bash
python -m llama_cpp.server \
  --model path/to/your/model.gguf \
  --host 0.0.0.0 \
  --port 8080
```

### 4. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

–ü–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º –ø—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –≤—Å–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ.

```bash
python test_bot.py
```
–≠—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç –ø—Ä–æ–≤–µ—Ä–∏—Ç —Ç–æ–∫–µ–Ω, –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å LLaMA —Å–µ—Ä–≤–µ—Ä–∞ –∏ –≤–Ω—É—Ç—Ä–µ–Ω–Ω—é—é –ª–æ–≥–∏–∫—É.

### 5. –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞

–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ñ–ª–∞–≥ `-m` –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –±–æ—Ç–∞ –∫–∞–∫ –º–æ–¥—É–ª—è –∏–∑ –∫–æ—Ä–Ω–µ–≤–æ–π –ø–∞–ø–∫–∏ –ø—Ä–æ–µ–∫—Ç–∞.

```bash
python -m src.bot
```

## üìÅ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

```
LocalAiChat/
‚îú‚îÄ‚îÄ src/                  # –û—Å–Ω–æ–≤–Ω–æ–π –∏—Å—Ö–æ–¥–Ω—ã–π –∫–æ–¥
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py       # –î–µ–ª–∞–µ—Ç src –ø–∞–∫–µ—Ç–æ–º
‚îÇ   ‚îú‚îÄ‚îÄ bot.py            # –õ–æ–≥–∏–∫–∞ Telegram –±–æ—Ç–∞ (—Ö—ç–Ω–¥–ª–µ—Ä—ã)
‚îÇ   ‚îú‚îÄ‚îÄ llama_client.py   # –ö–ª–∏–µ–Ω—Ç –¥–ª—è LLaMA API
‚îÇ   ‚îî‚îÄ‚îÄ context_manager.py# –ú–µ–Ω–µ–¥–∂–µ—Ä –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –¥–∏–∞–ª–æ–≥–æ–≤
‚îú‚îÄ‚îÄ venv/                 # –í–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ (–≤ .gitignore)
‚îú‚îÄ‚îÄ config_example.py     # –§–∞–π–ª –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
‚îú‚îÄ‚îÄ test_bot.py           # –°–∫—Ä–∏–ø—Ç –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
‚îú‚îÄ‚îÄ requirements.txt      # –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ Python
‚îú‚îÄ‚îÄ README.md             # –≠—Ç–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
‚îî‚îÄ‚îÄ LICENSE               # –õ–∏—Ü–µ–Ω–∑–∏—è MIT
```

---

## üßê –û—Ç–≤–µ—Ç—ã –Ω–∞ –≤–∞—à–∏ –≤–æ–ø—Ä–æ—Å—ã

–¢–µ–ø–µ—Ä—å –¥–∞–≤–∞–π—Ç–µ —Ä–∞–∑–±–µ—Ä–µ–º –ª–æ–≥–∏–∫—É –∏ –æ–±—Ä–∞–±–æ—Ç–∫—É –æ—à–∏–±–æ–∫.

### 1. –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –ª–æ–≥–∏–∫–∞ –∑–∞–ø—É—Å–∫–∞ –ò–ò –º–æ–¥–µ–ª–∏?

–ù–∞—à –±–æ—Ç **–Ω–µ –∑–∞–ø—É—Å–∫–∞–µ—Ç** –ò–ò –º–æ–¥–µ–ª—å –Ω–∞–ø—Ä—è–º—É—é. –û–Ω —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–∞–∫ **–∫–ª–∏–µ–Ω—Ç** –¥–ª—è —É–∂–µ –∑–∞–ø—É—â–µ–Ω–Ω–æ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞ `llama-cpp-python`.

-   **`llama_client.py`**: –≠—Ç–æ—Ç –º–æ–¥—É–ª—å –æ—Ç–≤–µ—á–∞–µ—Ç –∑–∞ –æ–±—â–µ–Ω–∏–µ —Å —Å–µ—Ä–≤–µ—Ä–æ–º.
-   **–ú–µ—Ç–æ–¥ `send_message`**:
    1.  –§–æ—Ä–º–∏—Ä—É–µ—Ç `prompt` (—Ç–µ–∫—Å—Ç-–ø–æ–¥—Å–∫–∞–∑–∫—É) –¥–ª—è –º–æ–¥–µ–ª–∏, –≤–∫–ª—é—á–∞—è –∏—Å—Ç–æ—Ä–∏—é –¥–∏–∞–ª–æ–≥–∞.
    2.  –î–µ–ª–∞–µ—Ç –æ–±—ã—á–Ω—ã–π HTTP POST-–∑–∞–ø—Ä–æ—Å –Ω–∞ —ç–Ω–¥–ø–æ–∏–Ω—Ç `/completion` –≤–∞—à–µ–≥–æ LLaMA —Å–µ—Ä–≤–µ—Ä–∞.
    3.  –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç `prompt` –∏ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã (—Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—É, —Å—Ç–æ–ø-—Ç–æ–∫–µ–Ω—ã) –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON.
    4.  –ñ–¥–µ—Ç JSON-–æ—Ç–≤–µ—Ç –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞, –∏–∑–≤–ª–µ–∫–∞–µ—Ç –∏–∑ –Ω–µ–≥–æ —Ç–µ–∫—Å—Ç –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –µ–≥–æ –±–æ—Ç—É.

**üêç –ß–µ–º—É –º—ã —É—á–∏–º—Å—è:** –†–∞–∑–¥–µ–ª–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏. –ë–æ—Ç –æ—Ç–≤–µ—á–∞–µ—Ç –∑–∞ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º –≤ Telegram, –∞ –æ—Ç–¥–µ–ª—å–Ω—ã–π —Å–µ—Ä–≤–µ—Ä ‚Äî –∑–∞ —Ç—è–∂–µ–ª—ã–µ –≤—ã—á–∏—Å–ª–µ–Ω–∏—è —Å –Ω–µ–π—Ä–æ—Å–µ—Ç—å—é. –≠—Ç–æ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –¥–ª—è –ø–æ–¥–æ–±–Ω—ã—Ö —Å–∏—Å—Ç–µ–º.

### 2. –ß—Ç–æ –±—É–¥–µ—Ç, –µ—Å–ª–∏ —Å–µ—Ä–≤–µ—Ä –Ω–µ –ø–æ–¥–Ω–∏–º–µ—Ç—Å—è?

–ú—ã –ø—Ä–µ–¥—É—Å–º–æ—Ç—Ä–µ–ª–∏ —ç—Ç–æ –≤ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –º–µ—Å—Ç–∞—Ö:

1.  **–ü—Ä–∏ –∑–∞–ø—É—Å–∫–µ –±–æ—Ç–∞ (`src/bot.py`)**:
    -   –ü–µ—Ä–µ–¥ –Ω–∞—á–∞–ª–æ–º —Ä–∞–±–æ—Ç—ã –º—ã –≤—ã–∑—ã–≤–∞–µ–º `llama_client.check_server_health()`.
    -   –≠—Ç–æ—Ç –º–µ—Ç–æ–¥ –¥–µ–ª–∞–µ—Ç –ø—Ä–æ—Å—Ç–æ–π GET-–∑–∞–ø—Ä–æ—Å –∫ —ç–Ω–¥–ø–æ–∏–Ω—Ç—É `/health` LLaMA-—Å–µ—Ä–≤–µ—Ä–∞.
    -   –ï—Å–ª–∏ —Å–µ—Ä–≤–µ—Ä –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç, –≤ –∫–æ–Ω—Å–æ–ª–∏ –ø–æ—è–≤–∏—Ç—Å—è –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ: `‚ö†Ô∏è LLaMA server is not available.` –ë–æ—Ç –ø—Ä–æ–¥–æ–ª–∂–∏—Ç —Ä–∞–±–æ—Ç–∞—Ç—å, –Ω–æ –Ω–µ —Å–º–æ–∂–µ—Ç –æ—Ç–≤–µ—á–∞—Ç—å –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏—è.

2.  **–í–æ –≤—Ä–µ–º—è –¥–∏–∞–ª–æ–≥–∞ (`src/llama_client.py`)**:
    -   –í–µ—Å—å –∫–æ–¥ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∑–∞–ø—Ä–æ—Å–∞ –≤ –º–µ—Ç–æ–¥–µ `send_message` –æ–±–µ—Ä–Ω—É—Ç –≤ `try...except`.
    -   **–ï—Å–ª–∏ —Å–µ—Ä–≤–µ—Ä –≤—ã–∫–ª—é—á–µ–Ω**: —Å—Ä–∞–±–æ—Ç–∞–µ—Ç `except requests.exceptions.ConnectionError`. –í –∫–æ–Ω—Å–æ–ª—å –≤—ã–≤–µ–¥–µ—Ç—Å—è —á–µ—Ç–∫–∞—è –æ—à–∏–±–∫–∞ "–ù–µ —É–¥–∞–µ—Ç—Å—è –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ LLaMA —Å–µ—Ä–≤–µ—Ä—É". –ú–µ—Ç–æ–¥ –≤–µ—Ä–Ω–µ—Ç `None`.
    -   **–ï—Å–ª–∏ –±–æ—Ç –ø–æ–ª—É—á–∏–ª `None`**: –æ–Ω –æ—Ç–ø—Ä–∞–≤–∏—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é —Å–æ–æ–±—â–µ–Ω–∏–µ: "–ò–∑–≤–∏–Ω–∏—Ç–µ, –Ω–µ –º–æ–≥—É —Å–µ–π—á–∞—Å –æ—Ç–≤–µ—Ç–∏—Ç—å. –ü—Ä–æ–±–ª–µ–º–∞ –Ω–∞ —Å—Ç–æ—Ä–æ–Ω–µ –ò–ò-–º–æ–¥–µ–ª–∏."

### 3. –ß—Ç–æ –±—É–¥–µ—Ç, –µ—Å–ª–∏ –º–æ–¥–µ–ª–∏ –Ω–µ—Ç –ø–æ —É–∫–∞–∑–∞–Ω–Ω–æ–º—É –ø—É—Ç–∏?

–≠—Ç–æ –æ—à–∏–±–∫–∞ –Ω–∞ —Å—Ç–æ—Ä–æ–Ω–µ **LLaMA —Å–µ—Ä–≤–µ—Ä–∞**. –ö–æ–≥–¥–∞ –≤—ã –∑–∞–ø—É—Å–∫–∞–µ—Ç–µ `python -m llama_cpp.server --model /path/to/model`, –∏ –º–æ–¥–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω–∞, –ø—Ä–æ–∏–∑–æ–π–¥–µ—Ç –æ–¥–Ω–æ –∏–∑ –¥–≤—É—Ö:

-   **–°–µ—Ä–≤–µ—Ä –≤–æ–æ–±—â–µ –Ω–µ –∑–∞–ø—É—Å—Ç–∏—Ç—Å—è:** –û–Ω —Å—Ä–∞–∑—É –≤—ã–¥–∞—Å—Ç –æ—à–∏–±–∫—É –≤ –∫–æ–Ω—Å–æ–ª—å –∏ –∑–∞–≤–µ—Ä—à–∏—Ç —Ä–∞–±–æ—Ç—É. –î–ª—è –Ω–∞—à–µ–≥–æ –±–æ—Ç–∞ —ç—Ç–æ –±—É–¥–µ—Ç –≤—ã–≥–ª—è–¥–µ—Ç—å —Ç–∞–∫, –±—É–¥—Ç–æ —Å–µ—Ä–≤–µ—Ä –ø—Ä–æ—Å—Ç–æ –≤—ã–∫–ª—é—á–µ–Ω (—Å–º. –ø—É–Ω–∫—Ç 2).
-   **–°–µ—Ä–≤–µ—Ä –∑–∞–ø—É—Å—Ç–∏—Ç—Å—è, –Ω–æ –±—É–¥–µ—Ç –≤ "–±–æ–ª—å–Ω–æ–º" —Å–æ—Å—Ç–æ—è–Ω–∏–∏:** –≠–Ω–¥–ø–æ–∏–Ω—Ç `/health` –º–æ–∂–µ—Ç –≤–µ—Ä–Ω—É—Ç—å –æ—à–∏–±–∫—É. –ù–∞—à `check_server_health()` —ç—Ç–æ –æ–±–Ω–∞—Ä—É–∂–∏—Ç. –õ—é–±–æ–π –∑–∞–ø—Ä–æ—Å –∫ `/completion` —Ç–∞–∫–∂–µ –≤–µ—Ä–Ω–µ—Ç –æ—à–∏–±–∫—É (–Ω–∞–ø—Ä–∏–º–µ—Ä, `HTTP 500 Internal Server Error`).

–ù–∞—à `llama_client` –æ–±—Ä–∞–±–æ—Ç–∞–µ—Ç –∏ —ç—Ç–æ:
-   `if response.status_code == 200:` ‚Äî —ç—Ç–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–µ –ø—Ä–æ–π–¥–µ—Ç.
-   –ú—ã –≤—ã–≤–µ–¥–µ–º –≤ –ª–æ–≥ `‚ùå –û—à–∏–±–∫–∞ LLaMA —Å–µ—Ä–≤–µ—Ä–∞: 500 - Internal Server Error` (–∏–ª–∏ –¥—Ä—É–≥–æ–π –∫–æ–¥).
-   –ú–µ—Ç–æ–¥ –≤–µ—Ä–Ω–µ—Ç `None`, –∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ª—É—á–∏—Ç –≤–µ–∂–ª–∏–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –ø—Ä–æ–±–ª–µ–º–µ.

**–ò—Ç–æ–≥:** –í–∞—à –±–æ—Ç —Å–ø—Ä–æ–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω —Ç–∞–∫, —á—Ç–æ–±—ã –±—ã—Ç—å —É—Å—Ç–æ–π—á–∏–≤—ã–º –∫ –ø—Ä–æ–±–ª–µ–º–∞–º —Å LLaMA —Å–µ—Ä–≤–µ—Ä–æ–º. –û–Ω –Ω–µ "—É–ø–∞–¥–µ—Ç", –∞ —Å–æ–æ–±—â–∏—Ç –æ –ø—Ä–æ–±–ª–µ–º–µ –∏ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç —Ä–∞–±–æ—Ç–∞—Ç—å.

–ù–∞–¥–µ—é—Å—å, —Ç–µ–ø–µ—Ä—å —Å—Ç–∞–ª–æ –ø–æ–Ω—è—Ç–Ω–µ–µ! –ú—ã –Ω–µ —Ç–æ–ª—å–∫–æ –∏—Å–ø—Ä–∞–≤–∏–ª–∏ —Å—Ç—Ä—É–∫—Ç—É—Ä—É, –Ω–æ –∏ —Ä–∞–∑–æ–±—Ä–∞–ª–∏, –∫–∞–∫ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç—Å—è –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç—å –Ω–∞—à–µ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è. 